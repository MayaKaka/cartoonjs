<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pyramid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Facebook Open Graph Protocol http://ogp.me/ -->
  <meta property="og:title"         content="Pyramid" />
  <meta property="og:image"         content="http://www.davidscottlyons.com/threejs/thumbnails/pyramid-facebook.jpg" />
  <meta property="og:url"           content="http://davidscottlyons.com/threejs/pyramid/" />
  <meta property="og:site_name"     content="David Scott Lyons" />

  <!-- Styles -->
  <!-- <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet"> -->

  <script src="../js/libs/jquery-1.11.1.min.js"></script>

  <style type="text/css">
    html { overflow: hidden; }
    body { margin: 0; padding: 0; overflow: hidden; font-family: Arial, sans-serif; font-size: 12px; }
    a { color: #0fc; /*color: #fc0*/ }
    
    #info { text-align: left; color: #fff; position: absolute; width: 240px; padding: 15px; background: rgba(0,0,0,0.2); bottom: 50px; left: 10px; display: none; }
    #info h1 { margin: 0 0 10px; font-size: 20px; }
    h1 a { text-decoration: none; }
    #info-icon { position: absolute; left: 10px; bottom: 10px; background: rgba(0,0,0,0.3); width: 30px; height: 30px; font-weight: bold; text-align: center; line-height: 30px; color: #fff; font-family: monospace; font-size: 16px; }
    #info-icon:hover { cursor: pointer; background: rgba(0,0,0,0.4); }

    /* stats */
    #fps, #ms { background: transparent !important; }
    #fpsText, #msText { color: #777 !important; }
    #fpsGraph, #msGraph { display: none; }
  </style>


</head>

<body>

  <div id="container"></div>
  <div id="info-icon">i</div>
  <div id="info">
    <h1><a href="http://threejs.org" target="_blank">three.js</a> Pyramid</h1>
    Created by <a href="http://www.davidscottlyons.com/threejs" target="_blank">David Lyons</a><br>
    Concept by Melody Neumann<br>
    Sand from <a href="http://www.cgtextures.com/" target="_blank">cgtextures.com</a><br>
    Left mouse orbit, middle mouse zoom<br>
    Q,A,W,S keys to play notes
  </a></div>
  
  <script src="three/three.min.js"></script>
  <script src="three/controls/OrbitControls.js"></script>f
  <script src="three/SubdivisionModifier.js"></script>
  <script src="three/Detector.js"></script>
  <script src="three/libs/stats.min.js"></script>
  <script src="three/libs/dat.gui.min.js"></script>
  <script src="three/libs/tween.min.js"></script>

  <script>

    if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

    $('#info-icon').click(function(){ $('#info').fadeToggle('fast'); });

    var container, stats;

    var camera, controls, scene, raycaster, renderer;

    var cameraHelper;

    var gridHelper, mesh, brickMaterial;

    var pyramidGroup;

    var particleSystem, particleCount;

    var sprite;

    var sounds = [];

    var mouse = new THREE.Vector2(), INTERSECTED;

    var mouseX = 0, mouseY = 0;

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    var FLOOR = -100;



    var Sound = function ( sources ) {
      var audio = document.createElement( 'audio' );

      for ( var i = 0; i < sources.length; i++ ) {
        var source = document.createElement( 'source' );
        source.src = sources[ i ];
        audio.appendChild( source );
      }

      this.play = function () {
        audio.load();
        audio.play();
      }
    }



    init();
    animate();

    function init() {

      container = document.getElementById( 'container' );

      scene = new THREE.Scene();
      scene.fog = new THREE.Fog( 0xe3cab3, 500, 1000 );

      // brown: efd1b5

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setClearColor( 0xe3cab3, 1 );
      renderer.setSize( window.innerWidth, window.innerHeight );
      container.appendChild( renderer.domElement );

      camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 100000 );
      camera.position.x = 90;
      camera.position.z = 400;
      camera.position.y = 150;

      controls = new THREE.OrbitControls( camera, renderer.domElement );
      controls.minPolarAngle = Math.PI / 8; // radians
      controls.maxPolarAngle = Math.PI / 2; // radians
      controls.noPan = true;
      controls.minDistance = 200;
      controls.maxDistance = 700;

      // var axisHelper = new THREE.AxisHelper( 100 );
      // scene.add( axisHelper );

      // cameraHelper = new THREE.CameraHelper( camera );
      // scene.add( cameraHelper );

      // add objects here

      // Ambient light
      var light = new THREE.AmbientLight( 0x404040 ); // soft white light
      scene.add( light );

      // White directional light at half intensity shining from the top.
      var keyLight = new THREE.DirectionalLight( 0xffffff, 0.3 );
      keyLight.position.set( 1, 1, 1 );
      scene.add( keyLight );

      var fillLight = new THREE.DirectionalLight( 0xffffff, 0.3 );
      fillLight.position.set( -1, 0, -1 );
      scene.add( fillLight );

      // ------------------------------------------------------------

      // Dome
      var sphereMat = new THREE.MeshBasicMaterial({ color: 0x5a4d3e, wireframe: true, transparent: true, opacity: 0.6 });
      
      var sphere1Geo = new THREE.SphereGeometry(600, 20, 10);
      var sphere2Geo = new THREE.IcosahedronGeometry( 700, 2 );
      
      var sphere1 = new THREE.Mesh( sphere1Geo, sphereMat );
      var sphere2 = new THREE.Mesh( sphere2Geo, sphereMat );

      scene.add( sphere1 );
      scene.add( sphere2 );

      // ------------------------------------------------------------

      // Dust Particles

      // http://aerotwist.com/tutorials/creating-particles-with-three-js/
      // maybe try this instead? http://www.html5rocks.com/en/tutorials/casestudies/oz/

      // create the particle variables
      particleCount = 400;
      var particles = new THREE.Geometry();
      var pMaterial = new THREE.PointCloudMaterial({
            color: 0x7a5d43,
            size: 2
          });

      // now create the individual particles
      for (var p = 0; p < particleCount; p++) {

        // create a particle with random
        // position values, -250 -> 250
        var pX = Math.random() * 500 - 250,
            pY = Math.random() * 300 + FLOOR,
            pZ = Math.random() * 500 - 250,
            particle = new THREE.Vector3(pX, pY, pZ);

        // create a velocity vector
        particle.velocity = new THREE.Vector3(
          Math.random() * 5,              // x
          0, // y: random vel
          0);             // z

        // add it to the geometry
        particles.vertices.push(particle);
      }

      // create the particle system
      particleSystem = new THREE.PointCloud( particles, pMaterial );

      particleSystem.sortParticles = true;

      // add it to the scene
      scene.add( particleSystem );


      // ------------------------------------------------------------


      // Sprites / Hieroglyphs

      // var map = THREE.ImageUtils.loadTexture( "_assets/images/eye-of-horus.png" );

      // var map = THREE.ImageUtils.loadTexture( "_assets/images/hieroglyphs.png" );
      // var material = new THREE.SpriteMaterial( { map: map, color: 0xffffff, fog: true, transparent: true, opacity: 0.5 } );
      // sprite = new THREE.Sprite( material );
      // sprite.scale.set(80,80,80);
      // sprite.position.set( 50, 80, 50 );
      // scene.add( sprite );


      // ------------------------------------------------------------

      // Sand / Ground

      var sandColor = THREE.ImageUtils.loadTexture( "images/sand-color.png" );
      sandColor.wrapS = sandColor.wrapT = THREE.RepeatWrapping;
      sandColor.repeat.set( 4, 4 );
      var sandMat = new THREE.MeshLambertMaterial({ color: 0xcfbb9a, map: sandColor });

      var sandGeo = new THREE.PlaneBufferGeometry( 2048, 2048, 1, 1 );

      var sand = new THREE.Mesh( sandGeo, sandMat );
      scene.add( sand );
      sand.rotation.x = - Math.PI / 2;
      sand.position.y = FLOOR;


      // ------------------------------------------------------------


      pyramidGroup = new THREE.Group();

      var normalMap = THREE.ImageUtils.loadTexture( "images/normal.jpg" );
      var colorMap = THREE.ImageUtils.loadTexture( "images/color.jpg" );
      var specMap = THREE.ImageUtils.loadTexture( "images/spec.jpg" );

      brickMaterial = new THREE.MeshPhongMaterial( { ambient: 0x777777, color: 0xffffff, specular: 0xffffff, shininess: 7, shading: THREE.SmoothShading, side: THREE.DoubleSide, wireframe: false, transparent: false, opacity: 0.5, map: colorMap, normalMap: normalMap, specularMap: specMap } );

      var borderMaterial = new THREE.MeshPhongMaterial( { ambient: 0x777777, color: 0xffd7a0, specular: 0xffffff, shininess: 10, shading: THREE.SmoothShading, side: THREE.DoubleSide, wireframe: false, transparent: false, opacity: 0.5 } );

      var speakerMaterial  = new THREE.MeshPhongMaterial( { ambient: 0x777777, color: 0xae9066, specular: 0xffffff, shininess: 7, shading: THREE.SmoothShading, wireframe: false } );


      var speakerNum = 1;

      var loader = new THREE.JSONLoader();
      var baseCallback = function ( geometry, materials ) { createMesh( geometry, brickMaterial, false, "base", "" ) };
      var borderCallback = function ( geometry, materials ) { createMesh( geometry, borderMaterial, false, "borders", "" ) };
      var topCallback = function ( geometry, materials ) { createMesh( geometry, brickMaterial, true, "top", "" ) };
      // var speakerCallback = function ( geometry, materials ) { createMesh( geometry, speakerMaterial.clone(), false, "speakers" ) };

      loader.load( "models/pyramidBase.js", baseCallback);
      loader.load( "models/speakerBorders.js", borderCallback);
      loader.load( "models/pyramidTop.js", topCallback);
      // loader.load( "_assets/models/pyramid/speakers.js", speakerCallback);

      // for(var i = 1; i <= 8; i++){
      //   loader.load( "_assets/models/pyramid/speakers/speaker"+i+".js", speakerCallback);
      // }

      $.each( [1,2,3,4,5,6,7,8], function(index, value) {
        loader.load( "models/speaker"+value+".js",
          function ( geometry, materials ) {
            createMesh( geometry, speakerMaterial.clone(), false, "speakers", "speaker"+value );
          }
        );
      });


      scene.add( pyramidGroup );



      var sound1 = new Sound( [ 'sounds/Ab.mp3' ] );
      var sound2 = new Sound( [ 'sounds/Eb.mp3' ] );
      var sound3 = new Sound( [ 'sounds/A.mp3' ] );
      var sound4 = new Sound( [ 'sounds/E.mp3' ] );

      sounds = [sound1, sound2, sound3, sound4];


      raycaster = new THREE.Raycaster();


      stats = new Stats();
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.top = '0px';
      container.appendChild( stats.domElement );

      document.addEventListener( 'mousemove', onDocumentMouseMove, false );
      document.addEventListener( 'mousedown', onDocumentMouseDown, false );
      document.addEventListener( 'mouseup', onDocumentMouseUp, false );

      //

      window.addEventListener( 'resize', onWindowResize, false );

    }

    function createMesh( geometry, material, tween, group, name ) {

      if (group == 'speakers' || group == 'borders') {
        var modifier = new THREE.SubdivisionModifier( 1 );
        modifier.modify( geometry );
      }

      mesh = new THREE.Mesh( geometry, material );
      mesh.position.set( 0, FLOOR, 0 );
      mesh.scale.set( 2, 2, 2 );
      pyramidGroup.add( mesh );

      // var wireframe = new THREE.WireframeHelper( mesh, 0x000000 );
      // scene.add( wireframe );

      // var edgesHelper = new THREE.EdgesHelper(mesh, 0x000000);
      // scene.add( edgesHelper );

      // var helper = new THREE.FaceNormalsHelper( mesh, 10, 0x000000 );
      // scene.add( helper );

      if (name != "") mesh.name = name;
      // console.log(mesh.name);

      if (group != "") mesh.group = group;

      if (group == "top") {        
        var pointLight = new THREE.PointLight( 0x00ffcc, 0.6, 500 );
        pointLight.position.set( 0, 54, 0 )
        mesh.add( pointLight );

        var pointLight2 = new THREE.PointLight( 0x00ffcc, 0.6, 500 );
        pointLight2.position.set( 0, 130, 0 )
        pyramidGroup.add( pointLight2 );

        // var plh = new THREE.PointLightHelper( pointLight, 25 );
        // scene.add( plh );
        // var plh2 = new THREE.PointLightHelper( pointLight2, 25 );
        // scene.add( plh2 );
      }

      if (tween) setupTween(mesh);

      // setupGui();
    }
    
    // setupGui();


    // Tween.js
    // http://sole.github.com/tween.js/examples/03_graphs.html
    // http://learningthreejs.com/data/tweenjs_for_smooth_animation/tweenjs_for_smooth_animation.html
    // http://learningthreejs.com/blog/2011/08/17/tweenjs-for-smooth-animation/

    function setupTween(mesh) {
      var update  = function(){
        mesh.position.y = current.y;
      }

      var current = { y: FLOOR };
      var target = { y: FLOOR + 30 };

      var tween = new TWEEN.Tween(current)
        .to(target, 1500)
        .easing(TWEEN.Easing.Cubic.InOut)
        .onUpdate(update);

      var tween2 = new TWEEN.Tween(current)
        .to({ y: FLOOR + 5}, 1500)
        .easing(TWEEN.Easing.Cubic.InOut)
        .onUpdate(update);

      tween.chain(tween2);
      tween2.chain(tween);

      tween.start();
    }

    function tweenSpeaker(mesh, axis) {
      // var update  = function(){
      //   mesh.translateOnAxis( axis, current.distance );
      // }

      // var current = { distance: 0 };
      // var target = { distance: 2 };

      // var tween = new TWEEN.Tween(current)
      //   .to(target, 200)
      //   .easing(TWEEN.Easing.Cubic.InOut)
      //   .onUpdate(update);

      // var tween2 = new TWEEN.Tween(current)
      //   .to({ distance: -2 }, 200)
      //   .easing(TWEEN.Easing.Cubic.InOut)
      //   .onUpdate(update);

      // tween.chain(tween2);
      // tween.start();

      mesh.translateOnAxis( axis, 8 );
      setTimeout(function(){ mesh.translateOnAxis( axis, -12 ); }, 60);
      setTimeout(function(){ mesh.translateOnAxis( axis, 4 ); }, 120);
    }

    function setupGui() {
      // dat.GUI debugging -----------------------------------------

      var gui = new dat.GUI();

      // var opts = {
      //   spriteScale: 1
      // };

      var f1 = gui.addFolder('fog');
      // f1.add(camera, 'fov', 10, 135).onChange(function(){ camera.updateProjectionMatrix(); });
      f1.add(scene.fog, 'near', 1, 1000);
      f1.add(scene.fog, 'far', 500, 1500);
      // f1.add(opts, 'spriteScale', 1, 200).onChange(function(val){ sprite.scale.set(val,val,val); });

      f1.open();
      
      var f1 = gui.addFolder('material');
      f1.add(brickMaterial, 'shininess', 1, 30);
      f1.open();
    }


    function onWindowResize() {

      windowHalfX = window.innerWidth / 2;
      windowHalfY = window.innerHeight / 2;

      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();

      renderer.setSize( window.innerWidth, window.innerHeight );

    }

    function onDocumentMouseMove( event ) {

      event.preventDefault();

      // mouse x and y are between -1 and 1 (normalized?)
      mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
      mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

      findIntersections();

    }

    function onDocumentMouseDown( event ) {

      event.preventDefault();

      var vector = new THREE.Vector3( mouse.x, mouse.y, 1 ).unproject( camera );

      var raycaster = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );

      var intersects = raycaster.intersectObjects( pyramidGroup.children );

      if ( intersects.length > 0 ) {

        controls.enabled = false;

        SELECTED = intersects[ 0 ].object;

        if ( SELECTED.group == "speakers" ) {
          // console.log( SELECTED );
          // console.log( SELECTED.name );

          var name = parseInt( SELECTED.name.replace( "speaker", '') );
          // console.log( id );

          switch( name ) {
            // front : back :
            case 1: case 5: sounds[0].play(); break;
            case 2: case 6: sounds[1].play(); break;
            case 3: case 7: sounds[2].play(); break;
            case 4: case 8: sounds[3].play(); break;

            default: sounds[0].play(); break;
          }

          // face normal of pyramid base side
          var normal = new THREE.Vector3( 0.6457077325259278, 0.40832318480986296, 0.6452392586498092 );

          SELECTED.geometry.computeBoundingBox();
          var boundingBox = SELECTED.geometry.boundingBox;
          var centerX = 0.5 * ( boundingBox.max.x + boundingBox.min.x );
          var centerZ = 0.5 * ( boundingBox.max.z + boundingBox.min.z );
          // var centerY = 0.5 * ( boundingBox.max.y + boundingBox.min.y );
          // var center = new THREE.Vector3( centerX, centerY, centerZ);

          normal.x *= centerX > 0 ? 1 : -1;
          normal.z *= centerZ > 0 ? 1 : -1;
          
          tweenSpeaker(SELECTED, normal);

          // var arrow = new THREE.ArrowHelper(normal, center, 200, 0xff0000);
          // scene.add(arrow);
        }

      }

    }

    function onDocumentMouseUp( event ) {

      event.preventDefault();

      controls.enabled = true;

      if ( INTERSECTED ) {
        SELECTED = null;
      }

    }

    function findIntersections() {
      // find intersections

      var vector = new THREE.Vector3( mouse.x, mouse.y, 1 ).unproject( camera );

      raycaster.set( camera.position, vector.sub( camera.position ).normalize() );

      var intersects = raycaster.intersectObjects( pyramidGroup.children );

      if ( intersects.length > 0 ) {

        if ( INTERSECTED != intersects[ 0 ].object ) {

          if ( INTERSECTED ) {
            INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
            container.style.cursor = 'auto';
          }

          INTERSECTED = intersects[ 0 ].object;
          
          // console.log(INTERSECTED.name);

          // if ( INTERSECTED.name.indexOf('speaker') >= 0 ) {
          if ( INTERSECTED.group == "speakers" ) {
            INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
            INTERSECTED.material.emissive.setHex( 0x004f3f ); // orange: b73800
            container.style.cursor = 'pointer';
          }

        }

      } else {

        if ( INTERSECTED ) {
          INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
          container.style.cursor = 'auto';
        }

        INTERSECTED = null;

      }
    }

    //

    function animate() {
      requestAnimationFrame( animate );
      render();
      stats.update();
      TWEEN.update();
      controls.update();
    }

    function render() {
      // camera.lookAt( scene.position );

      // ------------------------------------------------

      particleSystem.rotation.y += 0.005;

      var pCount = particleCount;
      // while (pCount--) {
      while (false) {

        // get the particle
        var particle = particleSystem.geometry.vertices[ pCount ];

        // check if we need to reset
        if (particle.x > 250) {
          particle.x = -250;
          // particle.velocity.x = 0;
        }

        // update the velocity with a splat of randomniz
        // particle.velocity.x -= Math.random() * .1;

        // and the position
        particle.add( particle.velocity );
      }

      // flag to the particle system that we've changed its vertices.
      particleSystem.geometry.verticesNeedUpdate = true;

      // ------------------------------------------------

      renderer.render( scene, camera );
    }


    window.addEventListener('keydown', function (e) {
      // play note and speaker animation
      // - move into mesh.blast() function on speakers
      if (e.keyCode == 83) sounds[3].play(); // s
      if (e.keyCode == 81) sounds[0].play(); // q
      if (e.keyCode == 65) sounds[1].play(); // a
      if (e.keyCode == 87) sounds[2].play(); // w
    });


    // Egyptian Hieroglyph Iconography
    // Anubis, Jackal, Scarab Beetle, Cobra, Mummy, Falcon / Vulture
    // Sphynx, Pharoah
    // Eye of Horus / Ra
    // http://en.wikipedia.org/wiki/Egyptian_hieroglyphs

  </script>

</body>
</html>
